{
  "version": 3,
  "sources": ["../app.ts"],
  "sourcesContent": ["import * as L from 'https://esm.sh/leaflet@1.9.4';\r\n\r\n// Your 16\u2011hex\u2011digit device EUI for subscription\r\nconst DEVICE_EUI = '0004A30B010D3F45';\r\n\r\nlet map: L.Map;\r\nlet marker: L.Marker;\r\nlet circle: L.Circle;\r\n\r\n// Track current mode: false = standard, true = stolen\r\nlet isStolenMode = false;\r\n\r\n// --- Cookie helper functions ---\r\nfunction setCookie(name: string, value: string, days: number) {\r\n  const expires = new Date(Date.now() + days * 864e5).toUTCString();\r\n  document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;\r\n}\r\nfunction getCookie(name: string): string {\r\n  return document.cookie\r\n    .split('; ')\r\n    .reduce((r, v) => {\r\n      const [key, val] = v.split('=');\r\n      return key === name ? decodeURIComponent(val) : r;\r\n    }, '');\r\n}\r\n\r\n// Update UI elements based on current mode, including button color\r\nfunction updateModeUI() {\r\n  const mapEl = document.getElementById('map') as HTMLElement;\r\n  const btn = document.getElementById('sendDownlink') as HTMLButtonElement;\r\n  if (!mapEl || !btn) return;\r\n\r\n  if (isStolenMode) {\r\n    mapEl.style.display = 'block';\r\n    btn.textContent = 'Stop Tracking';\r\n    // Recalculate Leaflet map size when visible\r\n    requestAnimationFrame(() => map.invalidateSize());\r\n  } else {\r\n    mapEl.style.display = 'none';\r\n    btn.textContent = 'Report Stolen';\r\n    // Reset map view to default\r\n  }\r\n\r\n  // Toggle CSS classes for button color\r\n  btn.classList.toggle('stolen', isStolenMode);\r\n  btn.classList.toggle('standard', !isStolenMode);\r\n}\r\n\r\n// Initialize the Leaflet map (hidden by default)\r\nfunction setupMap() {\r\n  map = L.map('map').setView([51.505, -0.09], 13);\r\n  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n    attribution: '&copy; OpenStreetMap contributors'\r\n  }).addTo(map);\r\n\r\n  marker = L.marker([51.5, -0.09]).addTo(map)\r\n    .bindPopup('Current Location.')\r\n    .openPopup();\r\n  circle = L.circle([51.5, -0.09], { radius: 200 }).addTo(map);\r\n\r\n  document.getElementById('map')!.style.display = 'none';\r\n}\r\n\r\n/**\r\n * Parse incoming 13-byte payload:\r\n * [0\u20133] int32 lat (\u00D71e\u20137), [4\u20137] int32 lng (\u00D71e\u20137),\r\n * [8\u201311] uint32 accuracy (\u00F71e3), [12] battery %\r\n */\r\nfunction parsePayload(bytes: number[]): { lat: number; lng: number; acc: number; battery: number } {\r\n  const view = new DataView(new ArrayBuffer(bytes.length));\r\n  bytes.forEach((b, i) => view.setUint8(i, b));\r\n  return {\r\n    lat: view.getInt32(0, true) / 1e7,\r\n    lng: view.getInt32(4, true) / 1e7,\r\n    acc: view.getUint32(8, true) / 1e3,\r\n    battery: view.getUint8(12),\r\n  };\r\n}\r\n\r\n/**\r\n * Maps a percentage (0\u2013100) into one of 4 buckets:\r\n *   0% -> 0, 1\u201325% -> 1, 26\u201350% -> 2, 51\u2013100% -> 3\r\n * and returns its two-bit binary string (00, 01, 10, 11).\r\n */\r\nfunction decodeBatteryByte(byte: number): { percent: number; suffix: string } {\r\n  const idx = Math.min(3, byte & 0b11);\r\n  const percentMap = [0, 25, 50, 100];\r\n  const percent = percentMap[idx];\r\n  const suffix = idx.toString(2).padStart(2, '0');\r\n  return { percent, suffix };\r\n}\r\n/**\r\n * Updates the <img> with id=\"battery-icon\" to the appropriate\r\n * battery image based on the current percentage.\r\n */\r\nexport function updateBatteryIcon(percent: number): void {\r\n  const { percent: pct } = decodeBatteryByte(percent);\r\n  const img = document.getElementById('battery-icon') as HTMLImageElement;\r\n  if (!img) {\r\n    console.warn('Battery icon element not found');\r\n    return;\r\n  }\r\n  // pct will be one of [0,25,50,100]\r\n  const fileName = `battery_${pct}%.png`; // e.g. \"battery_25%.png\"\r\n  img.src = `/images/${fileName}`;\r\n}\r\n\r\n// Render an incoming frame, with guardrails per mode\r\nfunction renderFrame(frame: any) {\r\n  const hex = frame.data as string;\r\n  const raw = Array.from({ length: hex.length / 2 }, (_, i) =>\r\n    parseInt(hex.slice(i * 2, i * 2 + 2), 16)\r\n  );\r\n  const el = document.getElementById('sensor-data');\r\n  if (!el) return;\r\n\r\n  if (isStolenMode) {\r\n    if (raw.length !== 13) return;\r\n    const { lat, lng, acc, battery } = parsePayload(raw);\r\n    updateBatteryIcon(battery);\r\n    el.innerHTML = `<p>Latitude: ${lat.toFixed(6)}</p><p>Longitude: ${lng.toFixed(6)}</p>`;\r\n    marker.setLatLng([lat, lng]);\r\n    circle.setLatLng([lat, lng]).setRadius(acc);\r\n    map.panTo([lat, lng]);\r\n  } else {\r\n    if (raw.length !== 1) return;\r\n    // decode 0\u20133 byte into percent and suffix\r\n    const { percent } = decodeBatteryByte(raw[0]);\r\n    updateBatteryIcon(percent);\r\n    \r\n    el.innerHTML = `<p>Battery: ${percent}%</p>`;\r\n  }\r\n}\r\n\r\n\r\n// Toggle-mode button: flip state, persist cookie, send 1-byte downlink\r\nfunction setupDownlinkButton() {\r\n  const btn = document.getElementById('sendDownlink') as HTMLButtonElement | null;\r\n  if (!btn) return;\r\n  btn.addEventListener('click', () => {\r\n    isStolenMode = !isStolenMode;\r\n    setCookie('mode', isStolenMode ? '1' : '0', 7);\r\n    updateModeUI();\r\n    const hex = isStolenMode ? '01' : '00';\r\n    socket.send(JSON.stringify({ cmd: 'tx', EUI: DEVICE_EUI, data: hex, port: 2, confirmed: false, priority: 0 }));\r\n  });\r\n}\r\n\r\n// WebSocket setup: request cache & subscribe, then handle updates\r\nconst proto = location.protocol === 'https:' ? 'wss:' : 'ws:';\r\nconst socket = new WebSocket(`${proto}//${location.host}/ws`);\r\n\r\nsocket.onopen = () => {\r\n  socket.send(JSON.stringify({ cmd: 'cq', page: 1 }));\r\n  socket.send(JSON.stringify({ cmd: 'sub', EUI: DEVICE_EUI }));\r\n};\r\n\r\nsocket.onmessage = (evt) => {\r\n  const msg = JSON.parse(evt.data);\r\n\r\n  if (msg.cmd === 'cq') {\r\n    const cache = (msg.cache as any[])\r\n      .filter(i =>\r\n        i.EUI === DEVICE_EUI &&\r\n        (i.cmd === 'rx' || i.cmd === 'gw')\r\n      );\r\n    if (cache.length) {\r\n      const first = cache[0];\r\n      const bytes = Array.from({ length: (first.data as string).length / 2 }, (_, i) =>\r\n        parseInt((first.data as string).slice(i * 2, i * 2 + 2), 16)\r\n      );\r\n      const detectedStolen = bytes.length === 13;\r\n      if (detectedStolen !== isStolenMode) {\r\n        isStolenMode = detectedStolen;\r\n        setCookie('mode', isStolenMode ? '1' : '0', 7);\r\n        updateModeUI();\r\n      }\r\n      renderFrame(first);\r\n    }\r\n  } else if ((msg.cmd === 'gw' || msg.cmd === 'rx') && msg.EUI === DEVICE_EUI) {\r\n    renderFrame(msg);\r\n  }\r\n};\r\n\r\nsocket.onerror = (e) => console.error('WS error', e);\r\nsocket.onclose = () => console.log('WS closed');\r\n\r\n// Initial setup\r\n\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n  setupMap();\r\n  isStolenMode = getCookie('mode') === '1';\r\n  setupDownlinkButton();\r\n  updateModeUI();\r\n});\r\n"],
  "mappings": "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",
  "names": ["map", "marker", "circle"]
}
